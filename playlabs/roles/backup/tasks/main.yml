---

- name: Upload rollback script
  when: rollback_path is defined
  copy:
    dest: '{{ rollback_path }}'
    content: '{{ rollback_content }}'
    owner: root
    group: root
    mode: 0700

- name: Upload backup password
  copy:
    dest: '{{ home }}.backup_password'
    content: '{{ backup_password }}'
    owner: deploy
    group: root
    mode: 0700

- name: Init restic repository
  register: backup_init
  shell: 'RESTIC_REPOSITORY=restic RESTIC_PASSWORD_FILE=.backup_password restic init --repo restic'
  args:
    executable: /bin/bash
    creates: '{{ home }}restic'
    chdir: '{{ home }}'

- name: Upload backup script
  notify: backup unit
  copy:
    dest: '{{ script_path }}'
    content: '{{ script_content }}'
    owner: root
    group: root
    mode: 0700

- name: Create backup unit
  notify: backup unit
  copy:
    dest: /etc/systemd/system/{{ unit_name }}.service
    content: |
      [Unit]
      Description={{ unit_description }} unit

      [Service]
      ExecStart={{ script_path }}
      Type=oneshot
      StandardOutput=journal

      [Install]
      WantedBy=basic.target

- name: Create backup timer
  notify: backup unit
  copy:
    dest: /etc/systemd/system/{{ unit_name }}.timer
    content: |
      [Unit]
      Description={{ unit_description }} timer

      [Timer]
      OnBootSec=20m
      OnUnitActiveSec=1d

      [Install]
      WantedBy=timers.target

- name: Upload prune script
  notify: prune unit
  copy:
    dest: '{{ prune_path }}'
    content: '{{ prune_content }}'
    owner: root
    group: root
    mode: 0700

- name: Create prune unit
  notify: backup unit
  copy:
    dest: /etc/systemd/system/{{ unit_name }}.prune.service
    content: |
      [Unit]
      Description=Prune {{ unit_description }} unit

      [Service]
      ExecStart={{ prune_path }}
      Type=oneshot
      StandardOutput=journal

      [Install]
      WantedBy=basic.target

- name: Create prune timer
  register: prune_timer
  when: prune_path is defined
  copy:
    dest: /etc/systemd/system/{{ unit_name }}.prune.timer
    content: |
      [Unit]
      Description=Prune {{ unit_description }} timer

      [Timer]
      OnBootSec=20m
      OnUnitActiveSec=1d

      [Install]
      WantedBy=timers.target


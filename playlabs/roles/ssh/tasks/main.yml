---

- name: Install packages to add user
  package: name={{ item }}
  with_items:
  - '{{ "shadow" if ansible_os_family in ("Alpine", "Archlinux") else "passwd" }}'
  - sudo
  - bash

- name: Passwordless sudo for sudo group
  lineinfile:
    path: /etc/sudoers.d/passwordless
    line: '%sudo ALL=(ALL) NOPASSWD: ALL'
    create: yes
    owner: root
    group: root
    mode: 0600

- name: Set ssh service name for Arch
  when: ansible_os_family in ('Alpine', 'Archlinux', 'RedHat')
  set_fact:
    ssh_service_name: sshd

- name: Set ssh service name for Debian
  when: ansible_os_family in ('Debian')
  set_fact:
    ssh_service_name: ssh

- name: Install users group
  group:
    name: users
    state: present

- include: users.yml

- name: Find sshd configuration
  stat: path=/etc/ssh/sshd_config
  register: sshd_config

- name: Update sshd configuration
  notify: Restart sshd
  when: sshd_config.stat.exists
  with_dict: '{{ sshd_options }}'
  lineinfile:
    path: /etc/ssh/sshd_config
    line: '{{ item.key }} {{ item.value }}'
    regexp: '^#?{{ item.key }}'
    backup: yes

---
- name: Install pexpect
  when: ansible_os_family != 'Alpine'
  package: name=python3-pexpect

- name: Install pexpect
  when: ansible_os_family == 'Alpine'
  package: name=py3-pexpect
- name: Create super users (don't worry about the failures, it's the way it works for now)
  register: django_createsuperuser
  failed_when: false
  with_items: '{{ users|default([]) }}'
  when: item['name']|vaulted_password and ('superuser' in item.get('roles', {}).get(project_instance, []) or project_instance in item.get('roles', {}).get('superuser', {}))
  expect:
    timeout: 30
    command: docker exec -it {{ project_instance }} su uwsgi -c bash -c "django-admin createsuperuser"
    responses:
      'Username': ["{{ item['name'] }}"]
      'Email': ["{{ item['email'] }}"]
      'Password': ["{{ item['name']|vaulted_password }}", "{{ item['name']|vaulted_password }}"]

- name: How many users are in the database ?
  shell: docker exec {{ project_instance }} su uwsgi -c bash -c "echo 'from django.conf import settings; from django.apps import apps; print(apps.get_model(settings.AUTH_USER_MODEL).objects.count())' | django-admin shell"
  register: django_user_count
  changed_when: false
  when: users is not defined or not users

- name: We have found no user in the database, nor in your inventory, proposing basic superuseruser creation
  when: not users|default([]) and django_user_count.rc == 0 and django_user_count.stdout == "0"
  pause:
    minutes: 1
    prompt: Create a superuser with username and password of {{ lookup('env', 'USER') }} unless you abort NOW

- name: Createsuperuser with your current username as username and password
  when: not users|default([]) and django_user_count.rc == 0 and django_user_count.stdout == "0"
  expect:
    timeout: 30
    command: docker exec -it {{ project_instance }} su uwsgi -c bash -c "django-admin createsuperuser --username {{ lookup('env', 'USER') }} --email {{ lookup('env', 'USER') }}@{{ project_dns }}"
    responses:
      'Password': ["{{ lookup('env', 'USER') }}", "{{ lookup('env', 'USER') }}"]
      'Bypass': ["y"]

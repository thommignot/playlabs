---
# Use this playbook first to install python (for ansible) and setup your user
# (username: $USER) and RSA key ($HOME/.ssh/id_rsa.pub) when you have already a
# user + sudo ssh access.
#
# Once this playbook executed with success, check that you can connect with
# $USER@host and do `sudo -s` without being prompted by a password.
#
# Then you can use other playbooks such as ssh.yml to clean the SSH
# configuration and create other users.
#
# Example to bootstrap an arch linux server from Online.net:
#
#   ansible-playbook --ask-sudo-pass --become --become-user=root --become-method=sudo -i inventories/yourlabs/inventory -v playbooks/bootstrap/arch-sudo.yml

- hosts: all

  # Don't crash if python isn't installed, we'll install it
  gather_facts: False

  tasks:
  - name: Raw bootstrap.sh
    script: 'bootstrap.sh'
    register: out
    changed_when: "'+ exit 0' not in out.stdout_lines"

- hosts: all
  # Setup sudo without password and upload your ssh key.
  tasks:
  - name: Install sudo & shadow
    package: name=sudo,shadow state=present

  - name: Create sudo group
    group:
      name: sudo
      state: present

  - name: Passwordless sudo for sudo group
    lineinfile:
      path: /etc/sudoers.d/passwordless
      line: '%sudo ALL=(ALL) NOPASSWD: ALL'
      create: yes
      owner: root
      group: root
      mode: 0600

  - name: Install your admin account
    with_items:
    - root
    - '{{ lookup("env", "USER") }}'
    user:
      name: '{{ item }}'
      state: present
      shell: /bin/bash
      groups: sudo

  - name: Install your ssh key
    authorized_key:
      user: '{{ lookup("env", "USER") }}'
      state: present
      key: '{{ lookup("file", lookup("env", "HOME") + "/.ssh/id_rsa.pub") }}'

- hosts: all
  roles: [ssh]
